# Flattened configuration for MinCatFlow (original implementation)
# Converted from Hydra configs to simple YAML per CLAUDE.md guidelines

# Required field per CLAUDE.md
output_dir: "data/original/default"

# Experiment metadata
experiment:
  name: "mincatflow_original"
  version: "1.0.0"
  seed: 42
  deterministic: true

# Version tracking for WandB comparison
code_version: "original"

# Data configuration
data:
  train_lmdb_path: "dataset/train/dataset.lmdb"
  val_lmdb_path: "dataset/val_id/dataset.lmdb"
  test_lmdb_path: null
  batch_size:
    train: 512
    val: 512
    test: 512
  num_workers:
    train: 16
    val: 16
    test: 16
  preload_to_ram: true
  use_pyg: false

# Model architecture dimensions (reduced for fast testing)
model:
  atom_s: 256
  token_s: 256

  # Flow model arguments
  flow_model_args:
    atom_encoder_depth: 2
    atom_encoder_heads: 4
    atom_encoder_positional_encoding: false
    token_transformer_depth: 4
    token_transformer_heads: 4
    atom_decoder_depth: 2
    atom_decoder_heads: 4
    attention_impl: "pytorch"  # "pytorch", "xformers", "manual"
    activation_checkpointing: false
    dng: true  # Dynamic Nuclear Graph mode

  # Prior sampler arguments (computed from dataset statistics)
  prior_sampler_args:
    coord_std: 1.0
    # LogNormal parameters for lattice lengths (a, b, c)
    lognormal_loc: [1.5845935274470484, 1.8048289191348783, 2.0629395870811051]
    lognormal_scale: [0.3456883565588731, 0.4261945604282258, 0.4394933811412375]
    # Uniform parameters for lattice angles (alpha, beta, gamma)
    uniform_low: 60.0
    uniform_high: 120.0
    uniform_eps: 0.1
    # Supercell matrix normalization parameters
    supercell_mean: [
      [-0.026726, 0.078970, -0.065390],
      [-0.133529, 0.188983, -0.132132],
      [-0.013621, -0.254989, 0.140161]
    ]
    supercell_std: [
      [1.796400, 1.213596, 0.877900],
      [1.223385, 1.383904, 1.337392],
      [1.373271, 1.452034, 1.045282]
    ]
    # Prim slab coordinate standardization parameters
    prim_slab_coord_mean: [3.298159, 4.591314, 5.311862]
    prim_slab_coord_std: [2.842205, 3.540208, 4.057026]
    # Adsorbate center (center of mass) standardization parameters
    ads_center_mean: [3.376938, 4.558936, 11.428694]
    ads_center_std: [1.966149, 2.740428, 2.011135]
    # Adsorbate relative position standardization parameters
    ads_rel_pos_mean: [0.0, 0.0, 0.0]
    ads_rel_pos_std: [1.0, 1.0, 1.0]

  # Flow process arguments
  flow_process_args:
    num_sampling_steps: 50
    coordinate_augmentation: true
    synchronize_timesteps: false
    compile_model: false

  # Use optimized kernels
  use_kernels: false

# Training configuration
training:
  max_epochs: 20
  accelerator: "gpu"
  devices: 1
  strategy: "auto"
  precision: "bf16-mixed"
  accumulate_grad_batches: 1
  num_sanity_val_steps: 2
  gradient_clip_val: 10.0
  gradient_clip_algorithm: "norm"
  val_check_interval: 1.0

  # Loss configuration
  train_multiplicity: 1
  loss_type: "l2"  # "l1" or "l2"
  flow_loss_type: "v_loss"  # "v_loss" or "eps_loss"
  prim_slab_coord_loss_weight: 1.0
  ads_center_loss_weight: 1.0
  ads_rel_pos_loss_weight: 1.0
  length_loss_weight: 1.0
  angle_loss_weight: 0.01
  supercell_matrix_loss_weight: 1.0
  supercell_matrix_cosine_reg_weight: 0.0
  scaling_factor_loss_weight: 1.0
  prim_slab_element_loss_weight: 5.0  # Used when dng=True
  warmup_steps: 10000

  # Optimizer
  lr: 0.0001
  weight_decay: 0.0

  # Checkpointing
  checkpoint:
    save_top_k: 3
    save_last: true
    monitor: "val/total_loss"
    mode: "min"

# Validation configuration
validation:
  sample_every_n_epochs: 2
  flow_samples: 1
  sampling_steps: 50
  sampling_center_coords: false
  timeout: 120
  num_workers: 4
  # DNG-specific settings
  n_prim_slab_atoms_histogram_path: "primitive_atom_distribution.json"
  max_n_prim_slab_atoms: null
  # Adsorption energy evaluation
  compute_adsorption: false
  adsorption_device: "cuda"
  adsorption_model: "uma-m-1p1"
  adsorption_timeout: 100
  structure_matcher_args:
    ltol: 0.3
    stol: 0.5
    angle_tol: 10.0

# Prediction configuration
prediction:
  num_samples: 1
  sampling_steps: 50
  sampling_center_coords: false
  refine_final: false

# WandB configuration
wandb:
  enabled: true
  project: "CatGen"
  entity: null  # Your WandB username/team
  mode: "online"  # "online", "offline", "disabled"
  tags: []
  notes: ""
  watch_gradients: true
  watch_freq: 100
